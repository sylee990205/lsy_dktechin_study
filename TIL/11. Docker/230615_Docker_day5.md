# 230615 Docker Day 5
## 목차
---
## 도커파일로 이미지를 만드는 방법
- Dockerfile에 컨테이너에 넣을 이미지나 실행할 명령 등을 기술
```docker
# Dockerfile 스크립트의 예
FROM openjdk:11-jdk
ARG JAR_FILE=build/libs/*.jar
COPY ${JAR_FILE} app.jar
ENTRYPOINT ["java","-jar","/app.jar"]
```

```
docker build -t 생성할이미지이름 Dockerfile 경로
```

### Dockerfile 스크립트에 사용되는 주요 명령
- 대문자로 작성하는 것이 권장

| 인스트럭션 | 내용  
| ---------- | ---- 
| # | 주석 |
| FROM       | 토대가 되는 이미지 지정 
| ADD<br>COPY       | 이미지에 파일이나 폴더를 추가<br>ADD는 zip, 인터넷 url 등 가능<BR>COPY는 파일만 가능 |
| CMD        | 컨테이너를 실행할 때 실행할 명령어를 지정<br>간단한 명령어들을 CMD로 많이 작성함 |
| ENTRYPOINT | 컨테이너를 실행할 때 실행할 명령어를 **강제** 지정<br>이 도커이미지를 가동시킬때 반드시 실행해야하는 명령어로 ENTRYPOINT로 지정 |
| RUN | 이미지 빌드 과정에서 필요한 커맨드를 실행하기 위해 사용<br>이미지 안에 특정 소프트웨어를 설치하기 위해 많이 사용
| ARG | docker build 커맨드를 사용할 때 입력받을 수 있는 인자를 선언 |
| WORKDIR | 컨테이너 상에서 작업 디렉토리로 전환을 위해 사용<br>WORKDIR 실행 후 등장하는 모든 명령문은 해당 디렉토리 기준으로 실행 | 
#### CMD VS RUN
- RUN 명령문은 이미지 빌드시 항상 실행
  - **RUN 이미지가 만들어질때**
- 한 DockerFile에 여러 개의 RUN 명령문 선언 가능
- CMD 명령문은 이미지를 컨테이너로 기동시킬 때 딱 한 번 실행
  - **컨테이너가 기동될 때**

### nginx에 Vue.js 빌드 파일을 배포하여 컨테이너로 기동하는 Dockerfile
```docker
# develop stage
FROM node:11.1-alpine as develop-stage # node:11.1-alpine 이미지를 develop-stage라고 부르는 이미지로
WORKDIR /app 
# 명령어를 실행하는 작업 디렉토리
COPY package*.json ./
# package*.json을 ./로 복사
CMD ["npm","run","install"]
# npm run install을 실행
COPY . .
# 전체 파일을 전체 복사
# build stage
FROM develop-stage as build-stage
# develop-stage 이미지를 build-stage로
CMD ["npm","run","build"]
# npm run build 명령어를 수행
# production stage
FROM nginx:1.15.7-alpine as production-stage
COPY --from=build-stage /app/dist /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```
---
## 저장
### 이미지
- 이미지를 호스트 컴퓨터의 파일시스템에 tar 형식으로 저장
```
docker save -o 파일이름.tar 이미지이름
```

- 도커 엔진으로 가져올 때 load 명령
```
docker load -i 파일이름.tar
```
### 컨테이너
- 컨테이너를 파일로
```
docker export [컨테이너명 or 컨테이너ID] > 파일이름.tar
```
- 저장한 컨테이너를 도커 이미지로
```
docker import [파일이름.tar or URL] - [이미지이름[:태그]]
```

---
## 도커 이미지 저장소 : 도커 허브
- 직접 만든 이미지를 도커 허브에 업로드
- 비공개로 도커 허브와 같은 장소를 만들 수도 있음
### 이미지 저장소 용어 정리
- 도커 레지스트리 : 이미지 배포하는 장소
- 도커 허브 : 공식 도커 레지스트리
- 리포지토리 : 레지스트리 구성 단위

### 레지스트리(Registry)
- 도커 이미지를 관리하는 공간
- 도커 허브를 기본 레지스트리로 사용
- 레지스트리 분류
  - Docker Hub
  - Private Docker Hub
  - 회사 내부용

### 리포지토리(Repository)
- 레지스트리 내 도커 이미지가 저장되는 공간
- 이미지 이름이 리포지토리명으로 사용
- 깃허브의 리포지토리와 비슷한 역할

### 태그(Tag)
- 같은 이미지지만 **버전**별로 내용이 다름
- 해당 이미지를 설명하는 버전 정보
- latest 태그가 붙은 최신 버전이 주로 사용
- 굳이 숫자로 작성하지 않아도 됨

---
## 도커 컴포즈
- 시스템 관련 명령들을 하나의 파일에 작성하여 한번에 시스템 전체 실행, 종료 및 폐기까지 실행할 수 있는 도구
- 단일 서버에서 여러 개의 컨테이너를 하나의 서비스로 정의해 컨테이너의 묶음으로 관리할 수 있는 작업 환경을 제공하는 관리 도구
- yaml 포맷의 정의 파일
### 명령
- up
  - 정의 파일 내용대로 이미지를 내려 받고 컨테이너 생성 및 실행
  - 네트워크나 볼륨도 정의 가능
- down
  - 컨테이너와 네트워크를 정지 및 삭제
- stop
  - 컨테이너와 네트워크를 삭제없이 종료만 진행

### 도커 컴포즈 vs Dockerfile
- 도커 컴포즈 : 컨테이너와 주변 환경 및 네트워크, 볼륨까지 생성
- Dockerfile : 이미지를 만들기 위한 것, 네트워크나 볼륨 생성 불가

### 정의
- 정의 파일명  
docker-compose.yml
  - 다른 파일명을 이용할 때는 -f 옵션을 이용하여 지정
- 서비스와 컨테이너
  - 도커 컴포즈에서 서비스란 컨테이너가 모인 것을 의미
- 컴포즈 파일 작성 방법
  - 순서
    - 주 항목 -> 이름 추가 -> 설정
  - 주 항목
    ```yaml
    version: # 버전
    service: # 컨테이너 관련 정보 (컨테이너 정의)
    network: # 네트워크 관련 정보 (네트워크 정의)
    volumes: # 볼륨 관련 정보 (볼륨 정의)
    ```
  - 이름 추가 시 주 항목보다 한 단 들여쓰기
  - 공백으로 한 단 들여쓰기 사용, 공백 갯수 동일하게 설정
  - 탭 문자 사용 불가
  - 이름 뒤 반드시 `:` 사용
  - 한 줄에 이어서 설정 시 `:` 뒤에 공백 문자 1개 반드시 필요
  - 이름 뒤에 여러 개의 설정, 줄 바꿔 들여쓰기와 함께 `하이픈(-)+공백문자`

---
## 클라우드
- 클라우드 컴퓨팅
  - 서로 다른 물리적인 위치에 존재하는 컴퓨팅 자원을 가상화 기술로 통합해 제공하는 기술
    - 컴퓨팅 자원: 각종 소프트웨어, 하드웨어, 저장 매체
  - 사용자는 웹에만 접속하면 언제 어디서나 원하는 컴퓨팅 자원을 클라우드로부터 제공받아 사용 가능
  - 사용자는 사용한 컴퓨팅 자원만큼의 비용만 지급
- 클라우드 시스템
  - 시스템을 보유하는 것이 아니라 필요할 때만 시스템을 요구하기 위해 나온 시스템의 이용 형태 중 하나
  - 클라우드는 네트워크상에서 다양한 서비스를 필요에 따라서 이용하는 시스템 형태를 의미
  - 시스템 구축에 필요한 네트워크/서버/스토리지/애플리케이션을 서비스로 제공
- 퍼블릭 클라우드
  - 클라우드 서비스 기업이 인터넷을 통해 불특정 다수의 기업, 개인에게 컴퓨팅 리소스를 빌려주는 서비스
- 프라이빗 클라우드
  - 기업이 직접 클라우드 환경을 구축하고 내부에서만 컴퓨팅 리소스를 사용하는 서비스
###  public vs private
| | public | private |
| -- | ---- | ------ |
| 장점 | 유지관리 용이<br>사용량에 따른 비용 지불 가능<br>유동적으로 리소스 활용 가능 | 강력한 보안<br>비즈니스에 맞는 클라우드 환경 조성 가능
| 단점 | 데이터가 외부에 존재한다는 리스크 | 클라우드 관리를 위한 자체 전문 인력 필요
| 주요 적용 분야 | 메일, 일정관리 등 개인용 및 중소형 웹 비즈니스 서비스 | ERP 등의 기업 핵심 애플리케이션 및 중대형 웹 비즈니스 서비스

---
## PuTTY
![](/TIL/image/2023-06-15-15-18-01.png)
- 계정명@IP주소를 입력하면 이후에 다시 로그인하지않아도 됨
- 이 때 ec2-user는 AWS에서 운영체제별로 지정한 기본사용자명

---
## aws-linux 에 도커 엔진과 도커 컴포즈 설치
### yum
- 레드햇 계열의 리눅스 배포판에서 사용하는 프로그램 설치 관리 도구
- 패키지명이 없을 경우 전체 시스템에서 update 될 패키지를 확인 후 저장소 update
